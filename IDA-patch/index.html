<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>IDA打patch学习小结</title><meta name="description" content="A person often meets his destiny on the road he took to avoid it."><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="keypatch基本使用Edit -&amp;gt; Keypatch -&amp;gt; Patcher选中一行指令patch
可以输入汇编代码 nop啥的
Edit -&amp;gt; Keypatch -&amp;gt; Fill Range选中一定范围的指令一起patch
可以输入汇编代码
也可以输入16进制 “90” “0x90” “90,91” “AAh”等。
Edit -&amp;gt; Patch program -&amp;gt; Apply patches to input file撤消上一个操作，而且可以撤销多次（好像是无限制？亲测20次还是能继续撤销（好哎
Edit -&amp;gt; Patch program -&amp;gt; Apply patches to input file将修改保存到一个新的二进制文件（这是ida原本就有的功能
E.."><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Q1IQ's blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Q1IQ's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">IDA打patch学习小结</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#keypatch%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">keypatch基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Edit-gt-Keypatch-gt-Patcher"><span class="toc-text">Edit -&gt; Keypatch -&gt; Patcher</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Edit-gt-Keypatch-gt-Fill-Range"><span class="toc-text">Edit -&gt; Keypatch -&gt; Fill Range</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Edit-gt-Patch-program-gt-Apply-patches-to-input-file"><span class="toc-text">Edit -&gt; Patch program -&gt; Apply patches to input file</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Edit-gt-Patch-program-gt-Apply-patches-to-input-file-1"><span class="toc-text">Edit -&gt; Patch program -&gt; Apply patches to input file</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Edit-gt-Keypatch-gt-Search"><span class="toc-text">Edit -&gt; Keypatch -&gt; Search</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%87%E6%B3%A8"><span class="toc-text">备注</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93patch%E6%96%B9%E6%B3%95"><span class="toc-text">打patch方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#UAF"><span class="toc-text">UAF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%88%E6%BA%A2%E5%87%BA"><span class="toc-text">栈溢出</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A0%86%E6%BA%A2%E5%87%BA"><span class="toc-text">堆溢出</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#off-by-one-null"><span class="toc-text">off by one&#x2F;null</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA"><span class="toc-text">整数溢出</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E8%B6%8A%E7%95%8C"><span class="toc-text">数组越界</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-text">格式化字符串</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="toc-text">条件竞争</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8D%E5%A4%AA%E4%BC%98%E9%9B%85%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-text">不太优雅的方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Keystone%E5%BA%93-%E5%AE%89%E8%A3%85%E8%B8%A9%E5%9D%91"><span class="toc-text">Keystone库 安装踩坑</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/TOOL"><i class="tag post-item-tag">TOOL</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">IDA打patch学习小结</h1><time class="has-text-grey" datetime="2019-08-16T12:59:05.000Z">2019-08-16</time><article class="mt-2 post-content"><h3 id="keypatch基本使用"><a href="#keypatch基本使用" class="headerlink" title="keypatch基本使用"></a>keypatch基本使用</h3><h5 id="Edit-gt-Keypatch-gt-Patcher"><a href="#Edit-gt-Keypatch-gt-Patcher" class="headerlink" title="Edit -&gt; Keypatch -&gt; Patcher"></a>Edit -&gt; Keypatch -&gt; Patcher</h5><p>选中一行指令patch</p>
<p>可以输入汇编代码 nop啥的</p>
<h5 id="Edit-gt-Keypatch-gt-Fill-Range"><a href="#Edit-gt-Keypatch-gt-Fill-Range" class="headerlink" title="Edit -&gt; Keypatch -&gt; Fill Range"></a>Edit -&gt; Keypatch -&gt; Fill Range</h5><p>选中一定范围的指令一起patch</p>
<p>可以输入汇编代码</p>
<p>也可以输入16进制 “90” “0x90” “90,91” “AAh”等。</p>
<h5 id="Edit-gt-Patch-program-gt-Apply-patches-to-input-file"><a href="#Edit-gt-Patch-program-gt-Apply-patches-to-input-file" class="headerlink" title="Edit -&gt; Patch program -&gt; Apply patches to input file"></a>Edit -&gt; Patch program -&gt; Apply patches to input file</h5><p>撤消上一个操作，而且可以撤销多次（好像是无限制？亲测20次还是能继续撤销（好哎</p>
<h5 id="Edit-gt-Patch-program-gt-Apply-patches-to-input-file-1"><a href="#Edit-gt-Patch-program-gt-Apply-patches-to-input-file-1" class="headerlink" title="Edit -&gt; Patch program -&gt; Apply patches to input file"></a>Edit -&gt; Patch program -&gt; Apply patches to input file</h5><p>将修改保存到一个新的二进制文件（这是ida原本就有的功能</p>
<h5 id="Edit-gt-Keypatch-gt-Search"><a href="#Edit-gt-Keypatch-gt-Search" class="headerlink" title="Edit -&gt; Keypatch -&gt; Search"></a>Edit -&gt; Keypatch -&gt; Search</h5><p>可以搜索汇编指令，不能直接搜索16进制</p>
<p>多条指令用 <code>;</code> 分隔</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816211658.png"></p>
<h5 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h5><p>keypatch怕你忘了patch前的指令是啥，还加了个备注提醒。太贴心了</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816213618.png"></p>
<h3 id="打patch方法"><a href="#打patch方法" class="headerlink" title="打patch方法"></a>打patch方法</h3><h5 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h5><p>增加置0的代码 </p>
<h5 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h5><p>改读的字节数 </p>
<p>gets改成read</p>
<p>增加栈空间 sub rsp,xxxx</p>
<p>过滤不可见字符</p>
<h5 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h5><p>改读的字节数 </p>
<p>gets改成read</p>
<p>增加malloc申请的空间</p>
<p>过滤不可见字符</p>
<h5 id="off-by-one-null"><a href="#off-by-one-null" class="headerlink" title="off by one/null"></a>off by one/null</h5><p>改读的字节数 </p>
<h5 id="整数溢出"><a href="#整数溢出" class="headerlink" title="整数溢出"></a>整数溢出</h5><p>有符号跳转改为无符号</p>
<h5 id="数组越界"><a href="#数组越界" class="headerlink" title="数组越界"></a>数组越界</h5><p>有符号跳转改为无符号</p>
<p>增加判断index大小的代码 </p>
<h5 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h5><p>增加合适的参数，将printf(xxx)改为printf(“%s”,xxxxx) </p>
<h5 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h5><p>把sleep等消耗时间的函数nop掉</p>
<p>加锁（麻烦）</p>
<h5 id="不太优雅的方法"><a href="#不太优雅的方法" class="headerlink" title="不太优雅的方法"></a>不太优雅的方法</h5><p>nop 掉 free </p>
<p>nop 掉 malloc </p>
<p>在读的字节中过滤一些特殊的字符 </p>
<p>打乱got表 </p>
<h3 id="Keystone库-安装踩坑"><a href="#Keystone库-安装踩坑" class="headerlink" title="Keystone库 安装踩坑"></a>Keystone库 安装踩坑</h3><p>环境：macOS<br>python:2.7</p>
<p>python终端报错信息如下，网上说少so库，我没在系统里找到。</p>
<pre><code>&gt;&gt;&gt; import keystone
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
  File &quot;/usr/local/lib/python2.7/site-packages/keystone/__init__.py&quot;, line 4, in &lt;module&gt;
    from .keystone import Ks, ks_version, ks_arch_supported, version_bind, debug, KsError, __version__
  File &quot;/usr/local/lib/python2.7/site-packages/keystone/keystone.py&quot;, line 75, in &lt;module&gt;
    raise ImportError(&quot;ERROR: fail to load the dynamic library.&quot;)
ImportError: ERROR: fail to load the dynamic library.
</code></pre>
<p>解决方法：</p>
<pre><code>//下载
https://pypi.python.org/packages/9a/fc/ed0d3f46921bfaa612d9e8ce8313f99f4149ecf6635659510220c994cb72/keystone-engine-0.9.1-3.tar.gz</code></pre>
<pre><code>//安装
cd keystone-engine-0.9.1-3
sudo python setup.py install</code></pre>
<p>这下终端不报错了，ida还是报错</p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816201043.png"></p>
<p><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816201957.png"><br>解决方法：</p>
<pre><code>//查看keystone在哪
Python 2.7.16 (default, Jun 19 2019, 07:41:28) 
[GCC 4.2.1 Compatible Apple LLVM 10.0.0 (clang-1000.11.45.5)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import keystone
&gt;&gt;&gt; print keystone
&lt;module &#39;keystone&#39; from &#39;/usr/local/lib/python2.7/site-packages/keystone/__init__.pyc&#39;&gt;
&gt;&gt;&gt; print keystone.arm_const
&lt;module &#39;keystone.arm_const&#39; from &#39;/usr/local/lib/python2.7/site-packages/keystone/arm_const.pyc&#39;&gt;</code></pre>
<pre><code>//将其复制到ida.app里
$ sudo cp -r ./keystone /Applications/IDA\ Pro\ 7.0/ida.app/Contents/MacOS/python
$ sudo cp -r ./keystone /Applications/IDA\ Pro\ 7.0/ida64.app/Contents/MacOS/python
$ pwd
/usr/local/lib/python2.7/site-packages</code></pre>
<p>最后重启ida</p>
<p>成功！<br><img src="https://qiiq-1258887625.cos.ap-chengdu.myqcloud.com/20190816203552.png"></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/ByteCtf-note_five/" title="ByteCtf note_five 两种解法"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: ByteCtf note_five 两种解法</span></a><a class="button is-default" href="/pwnable-wp/" title="pwnable wp"><span class="has-text-weight-semibold">Next: pwnable wp</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Q1IQ" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/Q1iqF"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/Q1IQ"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/atom.xml"><i class="iconfont icon-rss"></i></a><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> Q1IQ 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>